name: Build Docker Image Only (No Push)

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  REGISTRY: docker.io
  IMAGE_NAME: ostrm

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          # - linux/arm64  # å¯é€‰ï¼šå¦‚éœ€ arm64 æž„å»ºï¼Œå–æ¶ˆæ³¨é‡Š
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract metadata
      id: meta
      run: |
        echo "timestamp=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
        echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
        echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

    - name: Sanitize platform name for artifact
      id: sanitize
      run: |
        PLATFORM_SANITIZED=$(echo "${{ matrix.platform }}" | sed 's/\//-/g')
        echo "platform_sanitized=${PLATFORM_SANITIZED}" >> $GITHUB_OUTPUT

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: ${{ matrix.platform }}
        push: false  # ä¸æŽ¨é€åˆ°ä»“åº“
        tags: |
          ostrm:${{ steps.meta.outputs.sha }}
          ostrm:${{ steps.meta.outputs.branch }}
        build-args: |
          APP_VERSION=${{ steps.meta.outputs.sha }}
        provenance: false
        sbom: false
        # ä½¿ç”¨ GHA ç¼“å­˜åŠ é€Ÿæž„å»º
        cache-from: |
          type=gha,scope=${{ matrix.platform }}
        cache-to: |
          type=gha,mode=max,scope=${{ matrix.platform }}
        outputs: type=docker,dest=/tmp/ostrm-image-${{ steps.sanitize.outputs.platform_sanitized }}.tar

    - name: Upload image artifact
      uses: actions/upload-artifact@v4
      with:
        name: ostrm-image-${{ steps.sanitize.outputs.platform_sanitized }}
        path: /tmp/ostrm-image-${{ steps.sanitize.outputs.platform_sanitized }}.tar
        retention-days: 7

    - name: Show build summary
      run: |
        echo "## ðŸ³ Docker Image Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | ${{ matrix.platform }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Artifact Name | ostrm-image-${{ steps.sanitize.outputs.platform_sanitized }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit SHA | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | ${{ steps.meta.outputs.branch }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Timestamp | ${{ steps.meta.outputs.timestamp }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ Image artifact has been uploaded and is available for 7 days."

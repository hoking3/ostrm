name: Build and Push Docker Image

on:
  push:
    tags:
      - 'v*.*.*'
      - 'beta-v*.*.*'

env:
  REGISTRY: docker.io
  IMAGE_NAME: ostrm

permissions:
  contents: read
  packages: write

jobs:
  # å¹¶è¡Œæž„å»º amd64 æž¶æž„
  build-amd64:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}
    if: |
      (github.ref_type == 'tag' && startsWith(github.ref_name, 'v') && !startsWith(github.ref_name, 'beta-v')) ||
      (github.ref_type == 'tag' && startsWith(github.ref_name, 'beta-v'))
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Check Docker Hub credentials
      env:
        DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
        DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      run: |
        if [ -z "$DOCKERHUB_USERNAME" ]; then
          echo "âŒ Error: DOCKERHUB_USERNAME variable is not configured"
          exit 1
        fi
        if [ -z "$DOCKERHUB_TOKEN" ]; then
          echo "âŒ Error: DOCKERHUB_TOKEN secret is not configured"
          exit 1
        fi
        echo "âœ… Docker Hub credentials are configured"

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Extract version tag
      id: version
      run: |
        echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        if [[ "${{ github.ref_name }}" == beta-v* ]]; then
          echo "is_beta=true" >> $GITHUB_OUTPUT
        else
          echo "is_beta=false" >> $GITHUB_OUTPUT
        fi

    - name: Build and push amd64 image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64
        push: true
        tags: docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:${{ github.ref_name }}-amd64
        build-args: |
          APP_VERSION=${{ github.ref_name }}
        provenance: false
        sbom: false
        # å¤šå±‚ç¼“å­˜ç­–ç•¥ï¼šGHAç¼“å­˜ + Registryç¼“å­˜
        cache-from: |
          type=gha,scope=amd64
          type=registry,ref=docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:buildcache-amd64
        cache-to: |
          type=gha,mode=max,scope=amd64
          type=registry,ref=docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:buildcache-amd64,mode=max

  # å¹¶è¡Œæž„å»º arm64 æž¶æž„ - ä½¿ç”¨åŽŸç”Ÿ arm64 runner
  build-arm64:
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.build.outputs.digest }}
    if: |
      (github.ref_type == 'tag' && startsWith(github.ref_name, 'v') && !startsWith(github.ref_name, 'beta-v')) ||
      (github.ref_type == 'tag' && startsWith(github.ref_name, 'beta-v'))
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Check Docker Hub credentials
      env:
        DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
        DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      run: |
        if [ -z "$DOCKERHUB_USERNAME" ]; then
          echo "âŒ Error: DOCKERHUB_USERNAME variable is not configured"
          exit 1
        fi
        if [ -z "$DOCKERHUB_TOKEN" ]; then
          echo "âŒ Error: DOCKERHUB_TOKEN secret is not configured"
          exit 1
        fi
        echo "âœ… Docker Hub credentials are configured"

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push arm64 image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/arm64
        push: true
        tags: docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:${{ github.ref_name }}-arm64
        build-args: |
          APP_VERSION=${{ github.ref_name }}
        provenance: false
        sbom: false
        # å¤šå±‚ç¼“å­˜ç­–ç•¥ï¼šGHAç¼“å­˜ + Registryç¼“å­˜
        cache-from: |
          type=gha,scope=arm64
          type=registry,ref=docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:buildcache-arm64
        cache-to: |
          type=gha,mode=max,scope=arm64
          type=registry,ref=docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:buildcache-arm64,mode=max

  # åˆ›å»ºå¤šæž¶æž„ manifest
  create-manifest:
    runs-on: ubuntu-latest
    needs: [build-amd64, build-arm64]
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Create and push manifest (release)
      if: startsWith(github.ref_name, 'v') && !startsWith(github.ref_name, 'beta-v')
      run: |
        # åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾çš„ manifest
        docker buildx imagetools create -t docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:${{ github.ref_name }} \
          docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:${{ github.ref_name }}-amd64 \
          docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:${{ github.ref_name }}-arm64
        
        # åˆ›å»º latest æ ‡ç­¾çš„ manifest
        docker buildx imagetools create -t docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:latest \
          docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:${{ github.ref_name }}-amd64 \
          docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:${{ github.ref_name }}-arm64
        
        echo "âœ… Multi-arch manifest created for ${{ github.ref_name }} and latest"

    - name: Create and push manifest (beta)
      if: startsWith(github.ref_name, 'beta-v')
      run: |
        docker buildx imagetools create -t docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:${{ github.ref_name }} \
          docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:${{ github.ref_name }}-amd64 \
          docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:${{ github.ref_name }}-arm64
        
        echo "âœ… Multi-arch manifest created for ${{ github.ref_name }}"

    - name: Verify manifests
      run: |
        echo "=== Verifying multi-arch manifests ==="
        docker buildx imagetools inspect docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:${{ github.ref_name }}

    - name: Create source code archive
      if: startsWith(github.ref_name, 'v') && !startsWith(github.ref_name, 'beta-v')
      run: |
        zip -r "ostrm-${{ github.ref_name }}-source.zip" . \
          -x "*.git*" \
          -x "node_modules/*" \
          -x "target/*" \
          -x "*.log" \
          -x ".DS_Store" \
          -x "Thumbs.db"
        ls -lh "ostrm-${{ github.ref_name }}-source.zip"

    - name: Build Changelog
      id: github_release
      if: startsWith(github.ref_name, 'v') && !startsWith(github.ref_name, 'beta-v')
      uses: mikepenz/release-changelog-builder-action@v4
      with:
        configuration: ".github/release-changelog-config.json"
        ignorePreReleases: true
        fetchViaCommits: true
        commitMode: true
        fetchReviewers: false
        fetchReleaseInformation: true
        includeOpen: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create GitHub Release
      if: startsWith(github.ref_name, 'v') && !startsWith(github.ref_name, 'beta-v')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        CHANGELOG="${{ steps.github_release.outputs.changelog }}"
        if [ -z "$CHANGELOG" ] || [ "$CHANGELOG" = "- No changes" ]; then
          CHANGELOG="## ðŸ“ Changes

        This release includes various improvements and bug fixes.

        For detailed changes, please check the commit history between tags."
        fi

        gh release create "${{ github.ref_name }}" \
          --title "Release ${{ github.ref_name }}" \
          --notes "$CHANGELOG" \
          --latest \
          "ostrm-${{ github.ref_name }}-source.zip"

    - name: Image digest summary
      run: |
        echo "## ðŸ³ Docker Image Built Successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Architecture | Image |" >> $GITHUB_STEP_SUMMARY
        echo "|--------------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| amd64 | \`docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:${{ github.ref_name }}-amd64\` |" >> $GITHUB_STEP_SUMMARY
        echo "| arm64 | \`docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:${{ github.ref_name }}-arm64\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Multi-arch | \`docker.io/${{ vars.DOCKERHUB_USERNAME }}/ostrm:${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
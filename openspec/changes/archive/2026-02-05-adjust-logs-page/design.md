# 调整日志页面 - 设计方案

## Context

### 当前状态

**前端日志页面** (`frontend/app/pages/logs/index.vue`):
- 使用 WebSocket 实现实时日志推送
- 自动滚动开关控制滚动行为
- 连接状态实时显示
- 支持清空显示功能
- 日志统计信息（总行数、错误、警告）

**后端组件**:
- `LogController` - 提供 REST API（获取日志、下载日志、获取统计、接收前端日志）
- `LogService` - 日志文件读写服务
- `LogWebSocketHandler` - WebSocket 处理器
- `WebSocketConfig` - WebSocket 配置
- `LogFileMonitorService` - 日志文件监控服务（轮询检测日志变化并广播）

### 约束条件
- 保持现有 UI 风格一致
- 简化实现，不引入新的外部依赖
- 确保删除日志功能的安全性

## Goals / Non-Goals

**Goals:**
- 移除 WebSocket 实时推送，改用手动刷新
- 简化前端代码，降低维护复杂度
- 保留日志查看核心功能（查看、筛选、下载）
- 新增删除日志功能
- 移除后端 WebSocket 相关组件

**Non-Goals:**
- 不修改日志文件格式或存储方式
- 不引入新的前端依赖
- 不修改日志级别筛选逻辑
- 不改变现有 API 的返回格式（删除接口除外）

## Decisions

### 1. 前端刷新机制

**决定**: 用"重新加载"按钮替代自动滚动和 WebSocket

**方案详情**:
- 移除 `autoScroll` 状态变量
- 移除 `wsConnected` 状态变量
- 将"自动滚动"开关替换为"重新加载"按钮
- 点击按钮调用 `loadLogs()` 重新获取日志
- 页面加载时自动调用一次 `loadLogs()`

### 2. 移除清空显示功能

**决定**: 移除"清空显示"按钮

**理由**:
- 清空显示只影响前端展示，不影响实际日志文件
- 刷新页面会重新加载完整日志，使该功能失去意义
- 用户真正需要的是删除日志文件，而非仅清空显示

### 3. 新增删除日志功能

**决定**: 添加"删除日志"按钮，调用后端 API 删除日志文件

**UI 位置**: 与"下载日志"按钮放在一起

**交互流程**:
1. 用户点击"删除日志"
2. 弹出确认框（需二次确认）
3. 确认后调用 `DELETE /api/logs/{logType}` 删除对应日志文件
4. 删除成功后清空前端显示并提示用户

**备选方案**: 支持删除全部日志（后端 + 前端）
- 由于用户需求是删除"前后端日志文件"，可考虑添加类型选择
- 当前设计：保留日志类型切换，删除当前选中的日志类型

### 4. 后端 API 设计

**决定**: 新增 `DELETE /api/logs/{logType}` 接口

```
DELETE /api/logs/{logType}
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| logType | String | 是 | 日志类型（backend/frontend） |

**响应格式**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

**错误处理**:
- 400: 无效的日志类型
- 404: 日志文件不存在
- 500: 服务器内部错误

### 5. 后端组件移除

**决定**: 移除以下组件

| 组件 | 文件路径 | 移除方式 |
|------|----------|----------|
| WebSocketConfig | `config/WebSocketConfig.java` | 删除文件 |
| LogWebSocketHandler | `component/LogWebSocketHandler.java` | 删除文件 |
| LogFileMonitorService | `service/LogFileMonitorService.java` | 删除文件 |

**检查依赖**: 确认这些组件没有其他模块引用后再删除。

## Risks / Trade-offs

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 用户依赖实时日志查看 | 低 | 中 | 手动刷新基本满足需求，日志产生不频繁 |
| 删除日志误操作 | 中 | 高 | 添加二次确认对话框 |
| WebSocket 组件有其他用途 | 低 | 中 | 删除前检查依赖关系 |

**权衡**:
- 优点: 代码简化，维护成本降低
- 缺点: 失去实时性，但对于日志查看场景影响有限

## Migration Plan

### 实施步骤

1. **后端修改**
   - 在 `LogController` 添加删除日志接口
   - 在 `LogService` 添加删除日志方法
   - 删除 WebSocket 相关组件
   - 移除 `LogFileMonitorService` 的 `@Component` 注解或删除文件

2. **前端修改**
   - 移除 WebSocket 相关代码
   - 移除自动滚动开关 UI
   - 添加重新加载按钮
   - 移除清空显示按钮
   - 添加删除日志按钮和确认对话框
   - 修改统计区域的连接状态显示

3. **验证测试**
   - 测试日志加载功能
   - 测试日志下载功能
   - 测试删除日志功能
   - 验证后端启动无 WebSocket 相关错误

### 回滚策略

如需回滚:
1. 从 Git 恢复前端和后端的修改文件
2. 恢复 WebSocket 相关组件
3. 前端自动回滚到 WebSocket 模式
